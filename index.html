<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kleinwalsertal Tourismus Statistik</title>

  <meta name="description" content="Live Tourismusstatistiken fÃ¼r Kleinwalsertal (Gemeinde Mittelberg) â€“ Ãœbernachtungen, AnkÃ¼nfte, Herkunft & Unterkunftsarten. Daten via data.gv.at Open Government Data API.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --primary:#1e3a5f;
      --accent:#4a9b7f;
      --bg:#fafbfc;
      --surface:#fff;
      --text:#1a2a3a;
      --text-sec:#5a6a7a;
      --border:#e5eaef;
      --radius:12px;
      --shadow:0 4px 16px rgba(0,0,0,0.08);
    }
    [data-theme="dark"] {
      --bg:#0d1117;
      --surface:#161b22;
      --text:#e6edf3;
      --text-sec:#8b949e;
      --border:#30363d;
    }
    * { box-sizing:border-box; margin:0; padding:0 }
    body {
      font-family:'DM Sans',sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header {
      background:linear-gradient(135deg,#1e3a5f,#4a9b7f);
      color:#fff;
      padding:40px 20px;
    }
    h1 {
      font-family:'Playfair Display',serif;
      font-size:2.5rem;
    }
    .status-pill {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 14px;
      background:rgba(255,255,255,0.15);
      border-radius:999px;
      font-size:.9rem;
    }
    .status-dot {
      width:8px;
      height:8px;
      border-radius:50%;
      background:#fbbf24;
    }
    .status-dot.live { background:#4ade80 }
    .status-dot.offline { background:#ef4444 }

    main {
      max-width:1300px;
      margin:0 auto;
      padding:40px 20px;
    }
    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:20px;
      margin-bottom:40px;
    }
    .card {
      background:var(--surface);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      padding:20px;
    }
    .kpi-label {
      font-size:.8rem;
      text-transform:uppercase;
      color:var(--text-sec);
      margin-bottom:6px;
    }
    .kpi-value {
      font-size:1.8rem;
      font-weight:700;
    }
    h2 {
      font-family:'Playfair Display',serif;
      margin-bottom:16px;
    }
    .chart-box {
      height:400px;
    }
    select,button {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      cursor:pointer;
    }
    footer {
      text-align:center;
      padding:30px;
      color:var(--text-sec);
      border-top:1px solid var(--border);
    }
  </style>
</head>
<body>

<header>
  <h1>Tourismus Statistik</h1>
  <p>Kleinwalsertal Â· Gemeinde Mittelberg</p>
  <div class="status-pill">
    <span class="status-dot" id="statusDot"></span>
    <span id="statusText">Lade...</span>
  </div>
</header>

<main>

  <!-- KPI -->
  <section class="grid">
    <div class="card">
      <div class="kpi-label">Ãœbernachtungen 2025</div>
      <div class="kpi-value" id="kpiNights">â€”</div>
    </div>
    <div class="card">
      <div class="kpi-label">AnkÃ¼nfte 2025</div>
      <div class="kpi-value" id="kpiArrivals">â€”</div>
    </div>
    <div class="card">
      <div class="kpi-label">Ã˜ Aufenthalt</div>
      <div class="kpi-value" id="kpiStay">â€”</div>
    </div>
    <div class="card">
      <div class="kpi-label">Top Herkunft</div>
      <div class="kpi-value" id="kpiTopCountry">â€”</div>
    </div>
  </section>

  <!-- Chart -->
  <section class="card">
    <h2>ðŸ“ˆ Jahresverlauf</h2>
    <div class="chart-box">
      <canvas id="mainChart"></canvas>
    </div>
  </section>

</main>

<footer>
  <p>Â© 2026 Â· Daten: Land Vorarlberg (OGD) Â· API: data.gv.at</p>
</footer>

<script>
const CONFIG = {
  API_URL: "https://www.data.gv.at/api/3/action/datastore_search",
  MAIN_RESOURCE: "4f86b84d-8f58-4f35-ae1a-d94bcdfcc8c9",
  COUNTRY_RESOURCE: "db9d31c0-e38b-43c0-aa27-00b8bb148ca5",
  GKZ: "80228"
};

let yearlyData = [];
let countryData = {};
let mainChart = null;

document.addEventListener("DOMContentLoaded", () => {
  loadData();
});

// =====================
// API
// =====================
async function fetchAPI(resourceId) {
  const params = new URLSearchParams({
    resource_id: resourceId,
    limit: 5000,
    q: JSON.stringify({ GKZ: CONFIG.GKZ })
  });

  const res = await fetch(`${CONFIG.API_URL}?${params}`);
  const json = await res.json();
  if (!json.success) throw new Error("API Fehler");
  return json.result.records;
}

// =====================
// LOAD
// =====================
async function loadData() {
  setStatus("loading","Lade...");
  try {
    const main = await fetchAPI(CONFIG.MAIN_RESOURCE);
    const countries = await fetchAPI(CONFIG.COUNTRY_RESOURCE);

    parseMain(main);
    parseCountries(countries);

    setStatus("live","Live");
    updateKPIs();
    renderChart();
  } catch (e) {
    console.error(e);
    setStatus("offline","Offline");
  }
}

// =====================
// PARSER
// =====================
function parseMain(records) {
  const agg = {};
  records.forEach(r => {
    const year = parseInt(r.Berichtsjahr);
    const nights = parseNum(r.NÃ¤chtigungen || r.Naechtigungen);
    const arrivals = parseNum(r.AnkÃ¼nfte || r.Ankuenfte);
    if (!year || year < 2016) return;

    if (!agg[year]) {
      agg[year] = { year, nights:0, arrivals:0 };
    }
    agg[year].nights += nights;
    agg[year].arrivals += arrivals;
  });
  yearlyData = Object.values(agg).sort((a,b) => a.year - b.year);
}

function parseCountries(records) {
  countryData = {};
  records.forEach(r => {
    const year = parseInt(r.Berichtsjahr);
    const nights = parseNum(r.NÃ¤chtigungen || r.Naechtigungen);
    let country = (r.Staat || r.Land || "Sonstige").trim();
    if (!year || year < 2016) return;

    if (/deutsch/i.test(country)) country = "Deutschland";
    else if (/Ã¶ster/i.test(country)) country = "Ã–sterreich";
    else if (/schweiz/i.test(country)) country = "Schweiz";

    if (!countryData[year]) countryData[year] = {};
    if (!countryData[year][country]) countryData[year][country] = 0;
    countryData[year][country] += nights;
  });
}

// =====================
// UI
// =====================
function updateKPIs() {
  const y = yearlyData.find(d => d.year === 2025) || yearlyData.at(-1);
  if (!y) return;

  document.getElementById("kpiNights").textContent = formatNum(y.nights);
  document.getElementById("kpiArrivals").textContent = formatNum(y.arrivals);
  document.getElementById("kpiStay").textContent =
    y.arrivals ? (y.nights / y.arrivals).toFixed(1) : "â€”";

  const c = countryData[y.year];
  if (c) {
    const top = Object.entries(c).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById("kpiTopCountry").textContent = top[0];
  }
}

function renderChart() {
  const ctx = document.getElementById("mainChart").getContext("2d");
  if (mainChart) mainChart.destroy();

  mainChart = new Chart(ctx,{
    type:"line",
    data:{
      labels: yearlyData.map(d=>d.year),
      datasets:[
        {
          label:"Ãœbernachtungen",
          data: yearlyData.map(d=>d.nights),
          borderColor:"#1e3a5f",
          tension:0.3
        },
        {
          label:"AnkÃ¼nfte",
          data: yearlyData.map(d=>d.arrivals),
          borderColor:"#4a9b7f",
          tension:0.3
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false
    }
  });
}

function setStatus(type,text) {
  const dot = document.getElementById("statusDot");
  const label = document.getElementById("statusText");
  dot.className = "status-dot " + (type === "live" ? "live" : "offline");
  label.textContent = text;
}

function parseNum(v) {
  if (!v) return 0;
  return parseInt(String(v).replace(/[.\s]/g,"")) || 0;
}

function formatNum(n) {
  return new Intl.NumberFormat("de-AT").format(Math.round(n));
}
</script>

</body>
</html>
