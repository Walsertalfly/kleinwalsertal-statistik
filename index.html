<script>
const CONFIG = {
  API_URL: "https://www.data.gv.at/api/3/action/datastore_search",
  MAIN_RESOURCE: "4f86b84d-8f58-4f35-ae1a-d94bcdfcc8c9",
  COUNTRY_RESOURCE: "db9d31c0-e38b-43c0-aa27-00b8bb148ca5",
  GKZ: "80228",

  MONTHS_DE: ['J√§n','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'],
  MONTHS_FULL: ['J√§nner','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'],

  COUNTRY_FLAGS: {
    'Deutschland':'üá©üá™','√ñsterreich':'üá¶üáπ','Schweiz':'üá®üá≠','Niederlande':'üá≥üá±',
    'Belgien':'üáßüá™','Frankreich':'üá´üá∑','Gro√übritannien':'üá¨üáß','Italien':'üáÆüáπ','Sonstige':'üåê'
  },
  COUNTRY_COLORS: ['#1e3a5f','#c9a227','#4a9b7f','#d4735e','#8b5cf6','#ec4899','#06b6d4','#f59e0b'],
  ACCOMMODATION_TYPES: {
    'Hotels':{icon:'üè®',color:'#1e3a5f'},
    'Ferienwohnungen':{icon:'üè†',color:'#4a9b7f'},
    'Private':{icon:'üè°',color:'#c9a227'},
    'Sonstige':{icon:'üèïÔ∏è',color:'#8b9eb3'}
  }
};

let yearlyData = [];
let monthlyData = {};
let countryData = {};
let accommodationData = {};

let mainChart, monthlyChart, countryPieChart, countryTrendChart, accommodationChart;

document.addEventListener('DOMContentLoaded', () => {
  initTheme();
  initEvents();
  loadData();
});


// =====================
// API FETCH
// =====================
async function fetchAPI(resourceId) {
  const params = new URLSearchParams({
    resource_id: resourceId,
    limit: 5000,
    q: JSON.stringify({ GKZ: CONFIG.GKZ })
  });

  const res = await fetch(`${CONFIG.API_URL}?${params}`);
  const json = await res.json();

  if (!json.success) throw new Error("API Fehler");
  return json.result.records;
}


// =====================
// LOAD DATA
// =====================
async function loadData() {
  setStatus('loading','Lade...');

  try {
    const mainRecords = await fetchAPI(CONFIG.MAIN_RESOURCE);
    const countryRecords = await fetchAPI(CONFIG.COUNTRY_RESOURCE);

    parseMainAPI(mainRecords);
    parseCountriesAPI(countryRecords);

    setStatus('live','Live');
  } catch (e) {
    console.error(e);
    setStatus('offline','Offline');
    alert("API konnte nicht geladen werden ‚Äì pr√ºfe Internet oder data.gv.at");
    return;
  }

  populateSelectors();
  updateAll();
}


// =====================
// PARSER
// =====================
function parseMainAPI(records) {
  const yearlyAgg = {};
  monthlyData = {};
  accommodationData = {};

  records.forEach(r => {
    const year = parseInt(r.Berichtsjahr);
    const month = parseMonth(r.Monat);
    const nights = parseNum(r.N√§chtigungen || r.Naechtigungen || r.Naechtigungen_Zahl);
    const arrivals = parseNum(r.Ank√ºnfte || r.Ankuenfte);
    const type = (r.Hauptgliederung || '').trim();
    const status = (r.Status || '').toLowerCase();

    if (!year || year < 2016) return;

    if (!yearlyAgg[year]) {
      yearlyAgg[year] = {
        year,
        nights: 0,
        arrivals: 0,
        months: new Set(),
        status: 'actual'
      };
    }

    yearlyAgg[year].nights += nights;
    yearlyAgg[year].arrivals += arrivals;
    yearlyAgg[year].months.add(month);

    if (/vorl√§ufig/.test(status)) {
      yearlyAgg[year].status = 'estimated';
    }

    if (!monthlyData[year]) monthlyData[year] = {};
    if (!monthlyData[year][month]) monthlyData[year][month] = 0;
    monthlyData[year][month] += nights;

    if (type && !/gesamt|insgesamt/i.test(type)) {
      if (!accommodationData[year]) accommodationData[year] = {};
      if (!accommodationData[year][type]) accommodationData[year][type] = 0;
      accommodationData[year][type] += nights;
    }
  });

  yearlyData = Object.values(yearlyAgg)
    .map(y => ({
      ...y,
      status: y.months.size < 12 ? 'estimated' : y.status
    }))
    .sort((a,b) => a.year - b.year);
}


function parseCountriesAPI(records) {
  countryData = {};

  records.forEach(r => {
    const year = parseInt(r.Berichtsjahr);
    const nights = parseNum(r.N√§chtigungen || r.Naechtigungen);
    let country = (r.Staat || r.Land || r.Herkunft || 'Sonstige').trim();

    if (!year || year < 2016) return;

    if (/deutsch/i.test(country)) country = 'Deutschland';
    else if (/√∂ster/i.test(country)) country = '√ñsterreich';
    else if (/schweiz/i.test(country)) country = 'Schweiz';
    else if (/niederl|holland/i.test(country)) country = 'Niederlande';
    else if (/belg/i.test(country)) country = 'Belgien';
    else if (/frank/i.test(country)) country = 'Frankreich';
    else if (/brit|uk|england/i.test(country)) country = 'Gro√übritannien';

    if (!countryData[year]) countryData[year] = {};
    if (!countryData[year][country]) countryData[year][country] = 0;
    countryData[year][country] += nights;
  });
}


// =====================
// HELPERS
// =====================
function parseMonth(s) {
  if (!s) return 1;
  const n = parseInt(s);
  if (!isNaN(n)) return n;

  const m = {
    'j√§nner':1,'jan':1,
    'februar':2,'feb':2,
    'm√§rz':3,'m√§r':3,'mar':3,
    'april':4,'apr':4,
    'mai':5,
    'juni':6,'jun':6,
    'juli':7,'jul':7,
    'august':8,'aug':8,
    'september':9,'sep':9,
    'oktober':10,'okt':10,
    'november':11,'nov':11,
    'dezember':12,'dez':12
  };

  return m[s.toLowerCase()] || 1;
}

function parseNum(v) {
  if (!v) return 0;
  return parseInt(String(v).replace(/[.\s]/g,'')) || 0;
}

function setStatus(type,text) {
  const dot = document.getElementById('statusDot');
  const label = document.getElementById('statusText');
  dot.className = 'status-dot ' + (type === 'live' ? '' : type);
  label.textContent = text;
}

function formatNum(n) {
  return n == null ? '‚Äî' : new Intl.NumberFormat('de-AT').format(Math.round(n));
}
</script>
